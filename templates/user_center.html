{% extends "base.html" %}
{% block title %} - 个人中心{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- 左侧：用户信息 -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <!-- 修改头像显示，使用avatar_url变量 -->
                    <img src="{{ avatar_url }}" 
                         alt="头像" class="rounded-circle mb-3" width="120" height="120"
                         onerror="this.src='/static/images/default-avatar.jpg'">
                    <h4>{{ user.username }}</h4>
                    <p class="text-muted">{{ user.email }}</p>
                    
                    <div class="mt-3">
                        <p><strong>真实姓名：</strong> {{ user.real_name or '未设置' }}</p>
                        <p><strong>联系电话：</strong> {{ user.phone or '未设置' }}</p>
                        <p><strong>注册时间：</strong> {{ user.created_at.strftime('%Y-%m-%d') if user.created_at else '未知' }}</p>
                    </div>
                    
                    <div class="mt-2">
                        {% if user.is_reviewer %}
                        <span class="badge bg-success">审核员</span>
                        {% else %}
                        <span class="badge bg-secondary">普通用户</span>
                        {% endif %}
                        
                        {% if user.is_verified %}
                        <span class="badge bg-info ms-1">已认证</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="card mt-3 shadow-sm">
                <div class="card-body">
                    <h6><i class="fas fa-chart-bar"></i> 账户状态</h6>
                    <ul class="list-unstyled mt-3">
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success"></i> 
                            已登录
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-id-card {{ 'text-success' if user.is_verified else 'text-secondary' }}"></i> 
                            实名认证：{{ '已认证' if user.is_verified else '未认证' }}
                        </li>
                        <li>
                            <i class="fas fa-shield-alt {{ 'text-success' if user.is_reviewer else 'text-secondary' }}"></i> 
                            审核权限：{{ '是' if user.is_reviewer else '否' }}
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- 右侧：功能入口 -->
        <div class="col-md-8">
            <!-- 统计卡片区域（新增） -->
            <div class="row mb-4">
                {% if current_user.is_reviewer %}
                <!-- 审核员看到的统计 -->
                <div class="col-md-4 mb-3">
                    <div class="card bg-warning bg-opacity-10">
                        <div class="card-body text-center">
                            <h3 id="pendingCount">{{ pending_count if pending_count else 0 }}</h3>
                            <p class="text-muted mb-0">待审作品</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card bg-info bg-opacity-10">
                        <div class="card-body text-center">
                            <h3 id="todayNewCount">{{ total_today_new_count if total_today_new_count else 0 }}</h3>
                            <p class="text-muted mb-0">今日新增</p>
                        </div>
                    </div>
                </div>
                <!-- 审核员看到的统计 -->
                <div class="col-md-4 mb-3">
                    <div class="card bg-success bg-opacity-10">
                        <div class="card-body text-center">
                            <h3 id="approvedCount">{{ total_approved_count if total_approved_count else 0 }}</h3>
                            <p class="text-muted mb-0">总审核量</p>
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- 普通用户看到的统计 -->
                <div class="col-md-4 mb-3">
                    <div class="card bg-primary bg-opacity-10">
                        <div class="card-body text-center">
                            <h3>{{ submission_count if submission_count else 0 }}</h3>
                            <p class="text-muted mb-0">我的投稿</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card bg-info bg-opacity-10">
                        <div class="card-body text-center">
                            <h3>{{ today_new_count if today_new_count else 0 }}</h3>
                            <p class="text-muted mb-0">今日新增</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card bg-success bg-opacity-10">
                        <div class="card-body text-center">
                            <h3>{{ approved_count if approved_count else 0 }}</h3>
                            <p class="text-muted mb-0">已通过</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-th-large"></i> 个人功能中心</h5>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        <!-- 第一行：账户管理 -->
                        <div class="col-md-4">
                            <a href="{{ url_for('user_profile') }}" class="text-decoration-none">
                                <div class="card h-100 border-primary hover-card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-user-edit fa-3x text-primary mb-3"></i>
                                        <h5 class="card-title">编辑个人资料</h5>
                                        <p class="card-text text-muted small">修改您的个人信息和头像</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        
                        <div class="col-md-4">
                            <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                <div class="card h-100 border-warning hover-card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-key fa-3x text-warning mb-3"></i>
                                        <h5 class="card-title">修改密码</h5>
                                        <p class="card-text text-muted small">更新您的登录密码</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        
                        <div class="col-md-4">
                            <a href="{{ url_for('real_name_auth') }}" class="text-decoration-none">
                                <div class="card h-100 border-success hover-card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-id-card fa-3x text-success mb-3"></i>
                                        <h5 class="card-title">实名认证</h5>
                                        <p class="card-text text-muted small">
                                            {% if user.is_verified %}
                                            <span class="text-success">✅ 已认证</span>
                                            {% else %}
                                            <span class="text-danger">❌ 未认证</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        
                        <!-- 第二行：投稿管理 -->
                        <div class="col-md-4">
                            <a href="{{ url_for('my_submissions') }}" class="text-decoration-none">
                                <div class="card h-100 border-info hover-card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-list fa-3x text-info mb-3"></i>
                                        <h5 class="card-title">我的投稿</h5>
                                        <p class="card-text text-muted small">查看和管理您的投稿作品</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        
                        <div class="col-md-4">
                            <a href="{{ url_for('submit_artwork') }}" class="text-decoration-none">
                                <div class="card h-100 border-success hover-card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-plus-circle fa-3x text-success mb-3"></i>
                                        <h5 class="card-title">投稿新作品</h5>
                                        <p class="card-text text-muted small">分享您的艺术作品</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        
                        <div class="col-md-4">
                            <a href="{{ url_for('user_feedback') }}" class="text-decoration-none">
                                <div class="card h-100 border-secondary hover-card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-headset fa-3x text-secondary mb-3"></i>
                                        <h5 class="card-title">联系客服</h5>
                                        <p class="card-text text-muted small">需要帮助？联系我们</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        
                        <!-- 第三行：审核员功能或申请 -->
                        {% if not user.is_reviewer %}
                        <div class="col-md-4">
                            <a href="{{ url_for('apply_reviewer') }}" class="text-decoration-none">
                                <div class="card h-100 border-danger hover-card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-user-shield fa-3x text-danger mb-3"></i>
                                        <h5 class="card-title">申请成为审核员</h5>
                                        <p class="card-text text-muted small">申请权限，参与作品审核</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        {% else %}
                        <!-- 审核员专用功能 -->
                        <div class="col-md-4">
                            <a href="{{ url_for('review_pending') }}" class="text-decoration-none">
                                <div class="card h-100 border-success hover-card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-tasks fa-3x text-success mb-3"></i>
                                        <h5 class="card-title">待审作品</h5>
                                        <p class="card-text text-muted small">
                                            待审作品：{{ pending_count if pending_count else 0 }}
                                        </p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        
                        <!-- 删除已审作品和审核统计卡片 -->
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- 快速数据统计（原来的部分，现在作为额外统计显示） -->
            <div class="row mt-3">
                <div class="col-md-3 col-6">
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <h6 class="text-muted">投稿数</h6>
                            <h4>{{ submission_count if submission_count else 0 }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <h6 class="text-muted">通过数</h6>
                            <h4 class="text-success">{{ approved_count if approved_count else 0 }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <h6 class="text-muted">待审数</h6>
                            <h4 class="text-warning">{{ pending_submission_count if pending_submission_count else 0 }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <h6 class="text-muted">搜索次数</h6>
                            <h4>{{ search_count if search_count else 0 }}</h4>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 快速操作 -->
            <div class="card mt-3 shadow-sm">
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{{ url_for('submit_artwork') }}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> 立即投稿
                        </a>
                        <a href="{{ url_for('user_feedback') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-question-circle"></i> 需要帮助？
                        </a>
                        <a href="{{ url_for('user_profile') }}" class="btn btn-outline-warning">
                            <i class="fas fa-edit"></i> 编辑资料
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 修改密码模态框 -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">修改密码</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('change_password') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="current_password" class="form-label">当前密码</label>
                        <input type="password" class="form-control" id="current_password" name="current_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="new_password" class="form-label">新密码</label>
                        <input type="password" class="form-control" id="new_password" name="new_password" required>
                        <div class="form-text">至少6个字符</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirm_new_password" class="form-label">确认新密码</label>
                        <input type="password" class="form-control" id="confirm_new_password" name="confirm_new_password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">确认修改</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 演示说明 -->
<hr class="my-4">
<div class="alert alert-info mt-3">
    <small>
        <i class="fas fa-info-circle"></i> 
        <strong>个人中心功能说明：</strong> 
        这里是用户个人中心主页，集成了账户管理、投稿管理、使用记录和互动功能。点击相应链接可进入详细功能页面。
    </small>
</div>

<style>
.hover-card {
    transition: all 0.3s ease;
    height: 100%;
}
.hover-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    cursor: pointer;
}
.card {
    border-radius: 10px;
}
</style>
{% endblock %}

{% block scripts %}
<script>
    // 页面加载完成后，可以添加一些交互效果
    document.addEventListener('DOMContentLoaded', function() {
        // 为所有卡片添加悬停效果
        const cards = document.querySelectorAll('.card.h-100');
        cards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
            });
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
        
        // 修改密码表单验证
        const passwordForm = document.querySelector('#changePasswordModal form');
        if (passwordForm) {
            passwordForm.addEventListener('submit', function(event) {
                const newPassword = document.getElementById('new_password').value;
                const confirmPassword = document.getElementById('confirm_new_password').value;
                
                if (newPassword !== confirmPassword) {
                    event.preventDefault();
                    alert('新密码与确认密码不一致！');
                    return false;
                }
                
                if (newPassword.length < 6) {
                    event.preventDefault();
                    alert('新密码至少需要6个字符！');
                    return false;
                }
                
                return true;
            });
        }
        
        // 更新统计数字的函数（新增）
        function updateStats(stats) {
            if (stats.pending_count !== undefined) {
                const pendingElement = document.getElementById('pendingCount');
                if (pendingElement) {
                    pendingElement.textContent = stats.pending_count;
                }
            }
            if (stats.approved_count !== undefined) {
                const approvedElement = document.getElementById('approvedCount');
                if (approvedElement) {
                    approvedElement.textContent = stats.approved_count;
                }
            }
            if (stats.today_new_count !== undefined) {
                const todayNewElement = document.getElementById('todayNewCount');
                if (todayNewElement) {
                    todayNewElement.textContent = stats.today_new_count;
                }
            }
        }
        
        // 监听审核事件（如果您在其他页面有审核功能，可以通过事件通信）
        // 检查是否有审核操作的消息
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('action') === 'reviewed') {
            // 如果是审核后返回，刷新页面获取最新数据
            setTimeout(function() {
                window.location.href = window.location.pathname; // 刷新页面
            }, 500);
        }
    });
</script>
{% endblock %}